<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>

	<!-- Cabbage Corp Toolset -->

	<DockScreen	UNID="&scCCCabbageCorpToolset;"
			name=				"Cabbage Corp Toolset"
			desc=				"Equipment Configuration"
			type=				"customItemPicker"
			backgroundID=		"&rsItemListScreen;"
			nestedScreen=		"true"
			>
			
		<Events>
			<OnGlobalPaneInit>
				; aScreenUNID is the UNID of the screen being shown
				; aScreen is the screen name (if this is a local screen)
				; aPane is the pane being shown
				; Action only appears if any item with the Cabbage attribute is installed.
				(if (and
						; If the following list exists then it counts as True
						(filter (objGetItems gPlayership "dI +cabbageCorp") theItem (itmIsKnown theItem))
						(eq aScreenUNID &dsShipInterior;)
						(eq aPane "Default")
						)
					(scrAddAction
						gScreen
						'cabbageCorp
						0
						"Cabbage Corp Toolset"
						"C"
						Nil
						(scrShowScreen gScreen "&scCCCabbageCorpToolset;")
						)
					)
			</OnGlobalPaneInit>
		</Events>
		
		<List>
			(filter (objGetItems gPlayership "dI +cabbageCorp") theItem (itmIsKnown theItem))
		</List>
		
		<Panes>
			<Default>
				<OnPaneInit>
					(block (actionStatus desc)
						(setq gItem (scrGetItem gScreen))
						
						(if gItem
							(block (theCategory)
								(setq desc (cat "Unit mass: " (strMassString (itmGetMass gItem)) "\n\n"))
								
								; Describe the item installed
								(setq desc (cat desc (objGetInstalledItemDesc gPlayerShip gItem) "."))
								
								; Display
								(scrSetDesc gScreen desc)
								)
							)
							
						;	Use Device Action
						
						(setq actionStatus (rpgCalcToolsetUseDeviceAction))
						(scrShowAction gScreen 'actionUseDevice (@ actionStatus 'visible))
						(scrEnableAction gScreen 'actionUseDevice (@ actionStatus 'enabled))
						(scrSetActionDesc gScreen 'actionUseDevice (@ actionStatus 'desc))
						
						;	Modify Hardware Action
						
						(setq actionStatus (rpgCalcToolsetModifyHardwareAction))
						(scrShowAction gScreen 'actionModifyHardware (@ actionStatus 'visible))
						(scrEnableAction gScreen 'actionModifyHardware (@ actionStatus 'enabled))
						(scrSetActionDesc gScreen 'actionModifyHardware (@ actionStatus 'desc))
						
						;	Modify Firmware Action
						
						(setq actionStatus (rpgCalcToolsetModifyFirmwareAction))
						(scrShowAction gScreen 'actionModifyFirmware (@ actionStatus 'visible))
						(scrEnableAction gScreen 'actionModifyFirmware (@ actionStatus 'enabled))
						(scrSetActionDesc gScreen 'actionModifyFirmware (@ actionStatus 'desc))
						)
				</OnPaneInit>
				<Actions>
					<Action id="actionUseDevice" default="1">
						(block Nil
							(scrShowScreen gScreen (itmGetStaticData gItem 'useScreen))
							)
					</Action>
					
					<Action id="actionModifyHardware">
						(block Nil
							(intModifyHardware (itmGetStaticData gItem 'CCItemSwap))
							(scrExitScreen gScreen)
							)
					</Action>
					
					<Action id="actionModifyFirmware">
						<ShowPane pane="ModifyFirmware"/>
					</Action>
					
					<Action id="actionDone" cancel="1">
						(scrExitScreen gScreen)
					</Action>
				</Actions>
			</Default>
			
			<ModifyFirmware>
				<OnPaneInit>
					(block (desc)
						(setq desc
							(cat "Are you sure you wish to reset your Cabbage Corp device's software to its factory state?"
								"\n\n"
								"This will not fix physical alterations or damage to the device, and it may compound existing issues."
								"\n\n"
								"This operation cannot be undone, and any current enhancements to the device will be lost."
								)
							)
						(scrSetDesc gScreen desc)
						)
				</OnPaneInit>
				<Actions>
					<Action id="actionApplyFactoryReset" default="1">
						(block (currentFuel newDevice baseFuel)
							(setq gItem (scrGetItem gScreen))
							(setq currentFuel (shpGetFuelLeft gSource))
							(setq newDevice (itmCreate (itmGetType gItem) 1))
							
							(shpRemoveDevice gSource gItem)
							(objRemoveItem gSource (itmSetProperty gItem 'installed Nil) 1)
							
							(if (eq (random 1 20) 1)
								(if (itmGetProperty gItem 'disrupted)
									(setq newDevice (itmSetProperty newDevice 'damaged True))
									(setq newDevice (itmSetProperty newDevice 'disrupted True))
								)
							)
							
							(objAddItem gSource newDevice)
							(shpInstallDevice gSource newDevice)
							
							(setq baseFuel (shpGetFuelLeft gSource))
							(shpConsumeFuel gSource (multiply (subtract currentFuel baseFuel) -1))
							(scrExitScreen gScreen)
						)
					</Action>
					
					<Action id="actionCancel" cancel="1">
						(scrExitScreen gScreen)
					</Action>
				</Actions>
			</ModifyFirmware>
		</Panes>
		
		<Language>
			<Text id="actionUseDevice">"[U]se Device"</Text>
			<Text id="actionUseDevice:howitzer">"Adjust the fire-rate of your weapon."</Text>
			<Text id="actionUseDevice:refinery">"Process raw ore into fuel rods."</Text>
			<Text id="actionUseDevice:shield">"Adjust the strength of your shields."</Text>
			<Text id="actionUseDevice:usable">"Access the controls for your device."</Text>
			<Text id="actionUseDevice:damaged">"This device's controls are too damaged to use.."</Text>
			<Text id="actionUseDevice:nothing">"This device does not include built-in controls."</Text>
			
			<Text id="actionModifyHardware">"[M]odify Hardware"</Text>
			<Text id="actionModifyHardware:drive">"Bypass the safety restrictions for your drives."</Text>
			<Text id="actionModifyHardware:reactor">"Bypass the safety restrictions for your reactor."</Text>
			<Text id="actionModifyHardware:shield">"Bypass the safety restrictions for your shields."</Text>
			<Text id="actionModifyHardware:undo">"Restore the safety restrictions for this device."</Text>
			<Text id="actionModifyHardware:usable">"Remove the safety restrictions for this device."</Text>
			<Text id="actionModifyHardware:damaged">"This device is too damaged to be modified."</Text>
			<Text id="actionModifyHardware:nothing">"This device cannot be physically modified."</Text>
			
			<Text id="actionModifyFirmware">"Modify [F]irmware"</Text>
			<Text id="actionModifyFirmware:usable">"Reset the firmware for this device."</Text>
			<Text id="actionModifyFirmware:damaged">"This device is too damaged to be modified."</Text>
			<Text id="actionModifyFirmware:voided">"This device's firmware controls cannot be accessed."</Text>
			
			<Text id="actionDone">"[D]one"</Text>
			
			<Text id="actionApplyFactoryReset">"[A]pply Factory Reset"</Text>
			
			<Text id="actionCancel">"[C]ancel"</Text>
		</Language>
	</DockScreen>

</TranscendenceModule>
